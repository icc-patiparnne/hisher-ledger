# Caddyfile - Default configuration (Community/No-Auth mode)
# Simple reverse proxy without authentication

(cors) {
    header {
        Access-Control-Allow-Methods "GET,OPTIONS,PUT,POST,DELETE,HEAD,PATCH"
        Access-Control-Allow-Headers content-type
        Access-Control-Max-Age 100
        Access-Control-Allow-Origin *
    }
}

(handle_path_route_without_auth) {
    # handle_path automatically strips the prefix from the request path
    handle_path {args.0}* {
        reverse_proxy {args.1} {
            # Pass forwarding headers so upstream knows the original URL
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Prefix {args.0}
        }
        import cors
    }
}

{
    order versions after metrics
}

:80 {
    import handle_path_route_without_auth "/api/ledger" "ledger:3068"

    handle /versions {
        versions {
            region "community"
            env "no-auth"
            endpoints {
                ledger /api/ledger/_info /api/ledger/_healthcheck
            }
        }
    }

    # Health check
    handle /health {
        respond "OK" 200
    }

    handle {
        respond "Bad Gateway" 502
    }
}
